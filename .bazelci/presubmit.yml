---
tasks:
  ubuntu2204:
    build_flags:
    - "--build_tag_filters=-nolinux"
    build_targets:
    - "..."
    test_flags:
    - "--@io_bazel_rules_go//go/config:race"
    - "--test_tag_filters=-nolinux"
    test_targets:
    - "..."
  ubuntu2404:
    build_flags:
    - "--build_tag_filters=-nolinux"
    build_targets:
    - "..."
    test_flags:
    - "--@io_bazel_rules_go//go/config:race"
    - "--test_tag_filters=-nolinux"
    test_targets:
    - "..."
  macos:
    build_flags:
    - "--build_tag_filters=-nomacos"
    build_targets:
    - "..."
    test_flags:
    - "--@io_bazel_rules_go//go/config:race"
    - "--test_tag_filters=-nomacos"
    test_targets:
    - "..."
  macos_legacy_watcher:
    platform: macos
    build_flags:
    - "--build_tag_filters=-nomacos"
    build_targets:
    - "..."
    test_flags:
    - "--@io_bazel_rules_go//go/config:race"
    - "--test_tag_filters=-nomacos"
    - "--test_env=IBAZEL_USE_LEGACY_WATCHER=1"
    test_targets:
    - "..."
  windows:
    build_flags:
    - "--build_tag_filters=-nowindows"
    - '--action_env=PATH=C:\tools\msys64\usr\bin;C:\tools\msys64\bin;C:\tools\msys64\mingw64\bin;C:\python3\Scripts\;C:\python3;C:\Windows\system32;C:\Windows;C:\Windows\System32\Wbem;C:\Windows\System32\WindowsPowerShell\v1.0;C:\Windows\System32\OpenSSH;C:\ProgramData\GooGet;C:\Program Files\Google\Compute Engine\metadata_scripts;C:\Program Files (x86)\Google\Cloud SDK\google-cloud-sdk\bin;C:\Program Files\Google\Compute Engine\sysprep;C:\ProgramData\chocolatey\bin;C:\Program Files\Git\cmd;C:\tools\msys64\usr\bin;c:\openjdk\bin;C:\Program Files (x86)\Windows Kits\8.1\Windows Performance Toolkit\;C:\Program Files\CMake\bin;c:\ninja;c:\bazel;c:\buildkite'
    - "--cpu=x64_windows"
    - "--compiler=mingw-gcc"
    - "--extra_toolchains=@local_config_cc//:cc-toolchain-x64_windows_mingw"
    - "--host_platform=@io_bazel_rules_go//go/toolchain:windows_amd64_cgo"
    - "--incompatible_enable_cc_toolchain_resolution"
    build_targets:
    - "..."
    test_flags:
    - "--test_tag_filters=-nowindows"
    - '--action_env=PATH=C:\tools\msys64\usr\bin;C:\tools\msys64\bin;C:\tools\msys64\mingw64\bin;C:\python3\Scripts\;C:\python3;C:\Windows\system32;C:\Windows;C:\Windows\System32\Wbem;C:\Windows\System32\WindowsPowerShell\v1.0;C:\Windows\System32\OpenSSH;C:\ProgramData\GooGet;C:\Program Files\Google\Compute Engine\metadata_scripts;C:\Program Files (x86)\Google\Cloud SDK\google-cloud-sdk\bin;C:\Program Files\Google\Compute Engine\sysprep;C:\ProgramData\chocolatey\bin;C:\Program Files\Git\cmd;C:\tools\msys64\usr\bin;c:\openjdk\bin;C:\Program Files (x86)\Windows Kits\8.1\Windows Performance Toolkit\;C:\Program Files\CMake\bin;c:\ninja;c:\bazel;c:\buildkite'
    # On Windows CI, bazel (bazelisk) needs %LocalAppData% to find the cache directory.
    # We invoke bazel in tests, so the tests need this, too.
    - "--test_env=LOCALAPPDATA"
    - "--test_env=PATH"
    - "--cpu=x64_windows"
    - "--compiler=mingw-gcc"
    - "--extra_toolchains=@local_config_cc//:cc-toolchain-x64_windows_mingw"
    - "--host_platform=@io_bazel_rules_go//go/toolchain:windows_amd64_cgo"
    - "--incompatible_enable_cc_toolchain_resolution"
    test_targets:
    - "..."
